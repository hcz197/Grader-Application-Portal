<% # Page that shows table overview of courses, generated by rails %>
<% # Also contains certain links based on type of user signed in %>

<% # If signed-in, show courses table%>
<% if user_signed_in? %>

  <% content_for :title do %>
    Courses
  <% end %>

  <p id="notice"><%= notice %></p>

  <h1>Courses</h1>
  <br />

  <% if current_user.user_type == 1 %>
    <table id="myTable">
  <% else %>
    <table id="myTable" >
  <% end %>

  
    <thead>
      <tr>
        <th>Course #</th>
        <th>Section #</th>
        <th>Course Name</th>
        <th>Meeting Days</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Enrolled</th>
        <th>Waitlist</th>
        <th># Graders</th>
        <% if current_user.user_type == 3 || current_user.user_type == 2 %>
          <th># Applications</th>
        <% end %>
        <th colspan="3">Actions</th>
      </tr>
      <tr id="search-box">
        <th><input type="text" id="col0" class="narrow-column" onkeyup="myFunction(this)" title="Type in a name"></th>
        <th><input type="text" id="col1" class="narrow-column" onkeyup="myFunction(this)" title="Type in a name"></th>
        <th><input type="text" id="col2" onkeyup="myFunction(this)" title="Type in a name"></th>
        <th><input type="text" id="col3" class="narrow-column" onkeyup="myFunction(this)" title="Type in a name"></th>
        <th><input type="text" id="col4" class="narrow-column" onkeyup="myFunction(this)" title="Type in a name"></th>
        <th><input type="text" id="col5" class="narrow-column" onkeyup="myFunction(this)" title="Type in a name"></th>
        <th><input type="text" id="col6" class="narrow-column" onkeyup="myFunction(this)" title="Type in a name"></th>
        <th><input type="text" id="col7" class="narrow-column" onkeyup="myFunction(this)" title="Type in a name"></th>
        <th><input type="text" id="col8" class="narrow-column" onkeyup="myFunction(this)" title="Type in a name"></th>
        <% if current_user.user_type == 3 || current_user.user_type == 2 %>
          <th><input type="text" id="col9" class="narrow-column" onkeyup="myFunction(this)" title="Type in a name"></th>
        <% end %>
        <th colspan="3">Filters</th>
      </tr>
    </thead>

    <% stu_apps = Grading.where :user_id => current_user.id %>
    <tbody>
      <% @courses.each do |course| %>
        <% graders = Grading.where :course_id => course.id, :isGrading => true %>
        <% course_apps = Grading.where :course_id => course.id %>
        <tr>
          <td style="text-align:center"><%= course.coursenum %></td>
          <td style="text-align:center"><%= course.sectionnum %></td>
          <td><%= course.coursename %></td>
          <td><%= course.days %></td>
          <td style="text-align:center"><%= course.starttime %></td>
          <td style="text-align:center"><%= course.endtime %></td>
          <td style="text-align:center"><%= course.enrolled %></td>
          <td style="text-align:center"><%= course.waitlist %></td>

          <% # Make sure there are graders, then output number of them %>
          <% if graders != nil %>
            <td style="text-align:center"><%= graders.length %></td>
          <% end %>

          <% # Make sure there are applications, then output them for admins only %>
          <% if (current_user.user_type == 3 || current_user.user_type == 2) && course_apps != nil %>
            <td style="text-align:center"><%= course_apps.length %></td>
          <% end %>

          <td><%= link_to 'Class Info', course %></td>

          <% # If the user is a student, allow them to Edit or Create applications %>
          <% if current_user.user_type == 1 %>

            <% existing_app = nil %>
            <% stu_apps.each do |app| %>
              <% if app.course_id == course.id %>
                <% existing_app = app; %>
              <% end %>
            <% end %>

            <% if existing_app != nil %>
              <td><%= link_to 'Edit App', edit_grading_path(existing_app, :course_id => course.id) %></td>
            <% else %>
              <td><%= link_to 'TA Apply', new_grading_path(:course_id => course.id) %></td>
            <% end %>

          <% # If the user is an instructor or admin, allow them to view a list of applications %>
          <% else %>
          
            <td><%= link_to 'Show Applications', gradings_path(:course_id => course.id) %></td>

          <% end %> 

          <% # All users are able to view a list of graders %>
          <td><%= link_to 'Show Graders', users_path(:course_id => course.id) %></td>

        </tr>
      <% end %>
    </tbody>
  </table>

  <br>

<script>
  // https://stackoverflow.com/questions/51187477/how-to-filter-a-html-table-using-simple-javascript
  function myFunction(ele) {
    var filter, table, tr, td, i;
    filter = ele.value.toUpperCase();
    table = document.getElementById("myTable");
    tr = table.getElementsByTagName("tr");
    for (i = 2; i < tr.length; i++) {
      // Hide the row initially.
      tr[i].style.display = "none";

      var idStr = ele.id;
      var idNum = idStr.substring(3);
      var input = tr[1].getElementsByTagName("input");
      for (j = 0; j < input.length; j++) {
        if (j != idNum){
          input[j].value = "";
        }
      }
      cell = tr[i].getElementsByTagName("td")[idNum];
      if (cell) {
        if (cell.innerHTML.toUpperCase().indexOf(filter) > -1) {
          tr[i].style.display = "";
        } 
      }
    }
  }
</script>

<% # If not signed in, redirect to sign-in page %>
<% else %>
  <% controller.redirect_to new_user_session_path %>
<% end %>